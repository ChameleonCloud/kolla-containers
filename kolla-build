#!/usr/bin/env bash
set -u

DIR="$(cd "$(dirname "${BASH_SOURCE[0]}" >/dev/null 2>&1)" && pwd)"
source <(sed -e '/^$/d' -e 's/^/export /g' "$DIR/.env")

mkdir -p "$DIR/build"

build_dir="$DIR/build"
python_bin="$DIR/kolla/.tox/$PYTHON_VERSION/bin/python"

# Create build directory with configuration specific to service
mkdir -p "$build_dir"
cat "$DIR/kolla-build.conf" "$DIR/$KOLLA_BUILD_PROFILE/kolla-build.conf" 2>/dev/null >"$build_dir/kolla-build.conf"
cat "$DIR/kolla-template-overrides.j2" "$DIR/$KOLLA_BUILD_PROFILE/kolla-template-overrides.j2" 2>/dev/null >"$build_dir/kolla-template-overrides.j2"

pushd "$DIR/kolla" >/dev/null
cleanup() {
	popd >/dev/null
}
trap cleanup EXIT

$python_bin tools/build.py \
  --config-dir="$build_dir" \
	--template-override="$build_dir/kolla-template-overrides.j2" \
	--type="$KOLLA_INSTALL_TYPE" \
	--base="$KOLLA_BASE" --base-tag="$KOLLA_BASE_TAG" --base-arch="$KOLLA_BASE_ARCH" \
	--registry="$DOCKER_REGISTRY" --namespace="$KOLLA_NAMESPACE" \
	--tag="$VERSION" \
	--profile="$KOLLA_BUILD_PROFILE" \
	"$@"
