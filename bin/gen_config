#!/usr/bin/env python
# Evaluates templated configuration files for services and outputs them to
# a tarball that can be extracted on the host machine
from jinja2 import Environment, FileSystemLoader
from io import BytesIO
import re
import sys
import tarfile
import yaml

service_name = sys.argv[1]
jinja_extension_re = r'.j2$'
dir = 'runtime_configs'

vars = yaml.load(open("%s/vars.yaml" % dir))
env = Environment(
  loader=FileSystemLoader("%s/%s" % (dir, service_name))
)

with tarfile.open("%s.tar" % service_name, 'w') as tar:
    for name in env.list_templates():
        template = env.get_template(name)
        rendered = template.render(vars)
        info = tar.gettarinfo(template.filename)
        info.name = "/etc/kolla/%s/%s" % (service_name, re.sub(jinja_extension_re, '', name))
        info.size = len(rendered)
        tar.addfile(info, fileobj=BytesIO(rendered.encode('utf-8')))
