#!/usr/bin/env python
# Evaluates templated configuration files for services and outputs them to
# a tarball that can be extracted on the host machine
from jinja2 import Environment, FileSystemLoader
from io import BytesIO
import re
import os
import sys
import tarfile
import yaml

service_name = sys.argv[1]
jinja_extension_re = r'.j2$'
dir = 'runtime_configs'
policy_dir = os.path.join(dir, 'policies')
config_dir = os.path.join(dir, service_name)

vars = yaml.load(open(os.path.join(dir, 'vars.yaml')))
env = Environment(
  loader=FileSystemLoader(config_dir)
)

with tarfile.open("%s.tar" % service_name, 'w') as tar:
    for name in env.list_templates():
        template = env.get_template(name)
        rendered = template.render(vars)
        info = tar.gettarinfo(template.filename)
        info.name = "/etc/kolla/%s/%s" % (service_name, re.sub(jinja_extension_re, '', name))
        info.size = len(rendered)
        tar.addfile(info, fileobj=BytesIO(rendered.encode('utf-8')))
    # Also add in all policies
    for file in os.listdir(policy_dir):
        tar.add(os.path.join(policy_dir, file), arcname="/etc/kolla/policies/%s" % file)
