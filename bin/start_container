#!/usr/bin/env bash
set -e -u -o pipefail

service="${1:-}"
tag="${2:-stable}"

if [[ -z "$service" || "$service" == "-h" || $service == "--help" ]]; then
  cat <<USAGE
Usage: $0 <service> [tag]

Runs a service container, optionally at a given tag (uses "stable" by default.)

Examples:
  # Run Horizon service
  $0 horizon

  # Run Nova Compute service at tag "ocata"
  $0 nova-compute ocata
USAGE
  exit 1
fi

base="centos"
install_type="source"
registry="192.5.87.124:5000"
log_dir="/var/log/$service"
config_dir="/etc/kolla/$service"
policy_dir="/etc/kolla/policies"
image="kolla/$base-$install_type-$service"

declare -a flags=()
flags+=(--rm)
flags+=(--net=host)
flags+=(-v "$config_dir:/var/lib/kolla/config_files")
flags+=(-v "$policy_dir:/var/lib/kolla/policies")
flags+=(-v "$log_dir:/var/log/kolla/$service")
flags+=(-v "/tmp:/tmp")
flags+=(-e KOLLA_CONFIG_STRATEGY="COPY_ALWAYS")
if [[ -n "${INTERACTIVE:-}" ]]; then
  flags+=(--entrypoint=/bin/bash)
  flags+=(--interactive)
  flags+=(--tty)
else
  flags+=(--detach)
fi

exec docker run "${flags[@]}" "$registry/$image:$tag"
