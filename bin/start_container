#!/usr/bin/env bash
set -e -u -o pipefail

service="${1:-}"
tag="${2:-stable}"

if [[ -z "$service" || "$service" == "-h" || $service == "--help" ]]; then
  cat <<USAGE
Usage: $0 <service> [tag]

Runs a service container, optionally at a given tag (uses "stable" by default.)

Examples:
  # Run Horizon service
  $0 horizon

  # Run Nova Compute service at tag "ocata"
  $0 nova-compute ocata
USAGE
  exit 1
fi

base="centos"
install_type="source"

log_dir="$LOG_PATH/$service"
config_dir="$CONF_PATH/$service"
policy_dir="$CONF_PATH/policies"

image="kolla/$base-$install_type-$service:$tag"

if [[ -n "${REGISTRY:-}" ]]; then
  image="$REGISTRY/$image"
  docker pull "$image"
fi

declare -a flags=()
flags+=(--rm)

if [[ "$(uname)" == "Darwin" ]]; then
  # Docker For Mac does not support --net=host
  # https://github.com/docker/for-mac/issues/2716
  flags+=(--publish-all)
else
  flags+=(--net=host)
fi

flags+=("--name=$service")
flags+=(-v "$config_dir:/var/lib/kolla/config_files")
flags+=(-v "$policy_dir:/var/lib/kolla/policies")
flags+=(-v "$log_dir:/var/log/kolla/$service")
flags+=(-v "/tmp:/tmp")
flags+=(-e KOLLA_CONFIG_STRATEGY="COPY_ALWAYS")
if [[ -n "${INTERACTIVE:-}" ]]; then
  flags+=(--entrypoint=/bin/bash)
  flags+=(--interactive)
  flags+=(--tty)
  # Force terminal size to match host
  # See https://github.com/moby/moby/issues/33794
  flags+=(-e COLUMNS="$(tput cols)")
  flags+=(-e LINES="$(tput lines)")
else
  flags+=(--detach)
fi

exec docker run "${flags[@]}" "$image"
